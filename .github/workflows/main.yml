name: Update EVE SDE Data

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays
  workflow_dispatch:
  push:
    paths:
      - 'scripts/extract_ore_data.py'
      - 'scripts/extract_item_volumes.py'

jobs:
  update-sde:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download latest SDE
        run: |
          curl -L -o sde.zip https://developers.eveonline.com/static-data/eve-online-static-data-latest-jsonl.zip
          unzip -o sde.zip
          ls -lh *.jsonl | head -10

      - name: Extract ore data
        run: python3 scripts/extract_ore_data.py --sde-path . --output data/ores.json

      - name: Extract item volumes
        run: python3 scripts/extract_item_volumes.py --sde-path . --output data/items.json

      - name: Validate output
        run: |
          python3 -c "
          import json
          with open('data/ores.json') as f:
              data = json.load(f)
          
          assert len(data['ores']) > 50, f\"Expected >50 ores, got {len(data['ores'])}\"
          assert len(data['minerals']) >= 7, f\"Expected >=7 minerals, got {len(data['minerals'])}\"
          assert len(data['reprocessing']) > 0, 'No reprocessing data'
          
          mineral_names = {m['name'] for m in data['minerals']}
          expected = {'Tritanium', 'Pyerite', 'Mexallon', 'Isogen', 'Nocxium', 'Zydrine', 'Megacyte'}
          missing = expected - mineral_names
          if missing:
              print(f'Note: Missing expected minerals: {missing}')
          
          print(f'✓ {len(data[\"ores\"])} ores, {len(data[\"minerals\"])} minerals, {len(data[\"reprocessing\"])} reprocessing entries')
          "

          # Validate items.json
          python3 -c "
          import json
          with open('data/items.json') as f:
              data = json.load(f)

          assert len(data['items']) > 1000, f\"Expected >1000 items, got {len(data['items'])}\"
          assert 'metadata' in data, 'Missing metadata'
          assert data['metadata']['itemCount'] == len(data['items']), 'Item count mismatch'

          # Check that items have required fields
          sample = data['items'][0]
          required_fields = ['typeID', 'name', 'volume', 'groupID', 'groupName', 'categoryID', 'categoryName']
          for field in required_fields:
              assert field in sample, f'Missing field: {field}'

          print(f\"✓ {len(data['items']):,} items, {data['metadata']['categoryCount']} categories\")
          "

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ores.json data/items.json
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: update SDE data from $(date +%Y-%m-%d)"
            git push
          fi